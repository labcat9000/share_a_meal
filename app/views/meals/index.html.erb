<div class="spacer-top"></div>

<!-- Wrapper controlled by Stimulus -->
<div data-controller="index-display">
  <div class="view-toggle">
    <button class="toggle-button active"
            id="list-view-btn"
            data-action="click->index-display#displayMealList"
            data-index-display-target="listButton">List</button>
    <button class="toggle-button"
            id="map-view-btn"
            data-action="click->index-display#displayMealMap"
            data-index-display-target="mapButton">Map</button>
  </div>

  <!-- Meal List -->
  <div id="meal-list" data-index-display-target="mealList">
    <div class="meal-cards">
      <% @meals.each do |meal| %>
        <%= link_to meal_path(meal), class: "meal-card-link" do %>
          <div class="meal-card">
            <div class="meal-card-inner">

              <!-- LEFT: Image or Placeholder -->
              <div class="meal-card-image">
                <% if meal.photo.attached? %>
                  <%= cl_image_tag meal.photo.key, class: "meal-image" %>
                <% else %>
                  <%= image_tag "meal-default.png.jpeg", class: "meal-image" %>
                <% end %>
              </div>

              <!-- RIGHT: Text Content -->
              <div class="meal-card-content">
                <h3 class="meal-title"><%= meal.name %></h3>
                <p class="meal-description"><%= truncate(meal.description, length: 80) %></p>
                <p class="meal-author">Cooked by: <strong><%= "#{meal.user.first_name} #{meal.user.last_name}" if meal.user %></strong></p>

                <!-- Admin Actions -->
                <div class="meal-actions">
                  <%= link_to edit_meal_path(meal), title: "Edit" do %>
                    <i class="fa fa-edit"></i>
                  <% end %>
                  |
                  <%= link_to meal_path(meal), method: :delete, data: { confirm: 'Are you sure?' }, title: "Delete" do %>
                    <i class="fa fa-trash"></i>
                  <% end %>
                </div>
              </div>

            </div>
          </div>
        <% end %>
      <% end %>
    </div>
  </div>

  <!-- Map Section -->
  <div id="meal-map"
       style="display: none;"
       data-index-display-target="mealMap"
       data-controller="map-index"
       data-map-index-api-key-value="<%= ENV['MAPBOX_API_KEY'] %>">
    <div class="map-wrapper">
      <div id="map"
           class="map-container"
           data-map-index-target="map"
           style="height: 60vh; border-radius: 12px;"></div>
    </div>
    <div class="map-footer">
      <div class="map-location">
        <p><strong>Montreal, QC</strong><br><small>Location is approximate</small></p>
      </div>
      <div class="map-buttons">
        <button id="locate-btn" class="map-btn" data-action="click->map-index#locatePosition">üìç Locate</button>
        <button id="directions-btn" class="map-btn">üß≠ Directions</button>
      </div>
    </div>
  </div>
</div>

<div class="spacer-bottom"></div>
