<div class="spacer-top"></div>

<!-- SEARCH + FILTER (ALL under filter controller) -->
<div data-controller="filter">
  <div class="container px-3 pt-4">
    <%= form_with url: meals_path, method: :get, local: true, class: "meal-search-form d-flex align-items-center gap-2" do |f| %>
      <!-- Search input -->
      <div class="position-relative flex-grow-1">
        <i class="fa fa-search meal-search-icon"></i>
        <%= f.text_field :query,
              value: params[:query],
              placeholder: "Search meals...",
              class: "form-control meal-search-input ps-5" %>
      </div>

      <!-- Filter button -->
      <button type="button"
              class="btn btn-outline-secondary rounded-circle"
              data-action="click->filter#toggle">
        <i class="fa fa-sliders-h"></i>
      </button>
    <% end %>
  </div>

  <!-- FILTER DRAWER (target for toggle) -->
  <div class="filter-drawer mt-3" data-filter-target="panel" hidden>
    <h5 class="mb-3">Filter Meals</h5>

    <%= form_with url: meals_path, method: :get, local: true do |f| %>
      <%= f.hidden_field :query, value: params[:query] %>

      <div class="mb-3">
        <%= f.label :category, class: "form-label" %>
        <%= f.select :category,
              options_for_select([""] + Meal.pluck(:category).uniq.compact.sort, params[:category]),
              {}, class: "form-select" %>
      </div>

      <div class="mb-3">
        <%= f.label :cuisine, class: "form-label" %>
        <%= f.select :cuisine,
              options_for_select([""] + Meal.pluck(:cuisine).uniq.compact.sort, params[:cuisine]),
              {}, class: "form-select" %>
      </div>

      <div class="d-flex justify-content-between mt-3">
        <%= link_to "Clear Filters", meals_path, class: "btn btn-outline-secondary" %>
        <%= f.submit "Apply Filters", class: "btn btn-warning" %>
      </div>
    <% end %>
  </div>
</div>

<!-- QUERY MESSAGE -->
<% if params[:query].present? %>
  <div class="text-center text-muted mt-2 mb-3">
    Showing results for: <strong><%= params[:query] %></strong>
  </div>
<% end %>

<!-- DISPLAY CONTROLLER -->
<div data-controller="index-display">
  <div class="view-toggle">
    <button class="toggle-button active"
            id="list-view-btn"
            data-action="click->index-display#displayMealList"
            data-index-display-target="listButton">List</button>
    <button class="toggle-button"
            id="map-view-btn"
            data-action="click->index-display#displayMealMap"
            data-index-display-target="mapButton">Map</button>
  </div>

  <!-- MEAL LIST -->
  <div id="meal-list" data-index-display-target="mealList">
    <div class="meal-cards">

      <% if @meals_by_name.present? %>
        <% @meals_by_name.each do |meal| %>
          <%= link_to meal_path(meal), class: "meal-card-link" do %>
            <%= render partial: "meal_card", locals: { meal: meal } %>
          <% end %>
        <% end %>
      <% end %>

      <% if @meals_by_name.blank? && @meals_by_ingredients.present? %>
        <div class="text-muted text-center my-4">
          <p>
            <strong>No meals found by name or description for "<%= params[:query] %>".</strong><br>
            But here are some meals that contain "<%= params[:query] %>" as an ingredient:
          </p>
        </div>
      <% end %>

      <% if @meals_by_ingredients.present? %>
        <% @meals_by_ingredients.each do |meal| %>
          <%= link_to meal_path(meal), class: "meal-card-link" do %>
            <%= render partial: "meal_card", locals: { meal: meal } %>
          <% end %>
        <% end %>
      <% end %>

      <% if @meals_by_name.blank? && @meals_by_ingredients.blank? %>
        <div class="text-center mt-5 text-muted">
          <p>No meals found for your search.</p>
          <%= link_to "Clear search", meals_path, class: "btn btn-outline-secondary mt-2" %>
        </div>
      <% end %>

    </div>
  </div>

  <!-- MAP -->
  <div id="meal-map"
       style="display: none;"
       data-index-display-target="mealMap"
       data-controller="map-index"
       data-map-index-api-key-value="<%= ENV['MAPBOX_API_KEY'] %>">
    <div class="map-wrapper">
      <div id="map"
           class="map-container"
           data-map-index-target="map"
           style="height: 60vh; border-radius: 12px;"></div>
    </div>
    <div class="map-footer">
      <div class="map-location">
        <p><strong>Montreal, QC</strong><br><small>Location is approximate</small></p>
      </div>
      <div class="map-buttons">
        <button id="locate-btn" class="map-btn" data-action="click->map-index#locatePosition">üìç Locate</button>
        <button id="directions-btn" class="map-btn">üß≠ Directions</button>
      </div>
    </div>
  </div>
</div>

<div class="spacer-bottom"></div>
